# Energy estimation TDP plugin <!-- omit in toc -->

This plugin estimate the energy consumption based on the TDP value of the machine and the CPU utilization.
The TDP (Thermal Design Power) is the maximum amount of heat generated by a computer component.
Refer to the [wikipedia page of TDP](https://en.wikipedia.org/wiki/Thermal_design_power) for more details.

The estimation calculation is done using the following formula, we consider only the TDP of the CPU and a maximum consumption equal to the TDP when CPU usage is a 100%:

```math
\Large Energy=\frac{cpu\_time\_delta*cpu\_time\_conversion\_factor*nb_{\text{vcpu}}*TDP}{10^6*pooling\_interval*nb_{\text{cpu}}}
```

- $`{cpu\_time\_delta}`$: Total usage of CPU in micro seconds.
- $`{cpu\_time\_conversion\_factor}`$: Conversion factor multiplier to ensure $`{cpu\_time\_delta}`$ is in micro seconds.
- $`nb_{\text{vcpu}}`$: Number of virtual CPU of the hosting machine.
- $`nb_{\text{cpu}}`$: Number of logical CPUs of the hosting machine.
- $`{polling\_interval}`$: Polling interval of the cpu_time_delta.


## Requirements

To work this plugin needs procfs.kernel plugin configured to be able to obtain kernel_cpu_time.
The cpu measurements have an additional attribute cpu_state, which allow to compute the estimate consumption for individual states of the CPU or as the total consumption (sum with cpu_state!="idle").

### Configuration

```toml
[plugins.energy-estimation-tdp]
poll_interval = "5s"
tdp = 100.0
nb_vcpu = 1.0
nb_cpu = 1.0
cpu_usage = "kernel_cpu_time"
cpu_time_conversion_factor = 1000
```

- `pool_interval`: must be identical to the poll_interval of input k8s plugin. Default value is 1s.
- `nb_vcpu`: number of virtual cpu allocated to the virtual machine. If it is a physical machine, assign it to value 1. Default value is 1.
- `nb_cpu`: number of logical cpu of the hosted machine. Using the lscpu or hwinfo, you can retrieve the number of cpu including all sockets.
- `tdp`: Thermal Design power; each CPU has a calculated thermal design value; the value can be find on internet (usually on CPU manufacturer); you need the exact CPU family (using command lscpu or hwinfo). For example, for Intel® Xeon® D Processor, family D-2183IT, the tpd can be found [it's intel documentation page](https://ark.intel.com/content/www/us/en/ark/products/136441/intel-xeon-d-2183it-processor-22m-cache-2-20-ghz.html). The tdp value is 100W (so the default value is 100).
- `cpu_usage`: Input metric name that should exist in the metrics pipeline
- `cpu_time_conversion_factor`: Conversion factor for the cpu_usage to have micro seconds units
